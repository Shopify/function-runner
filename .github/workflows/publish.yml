name: Publish

on:
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag name"
        required: true
        type: string

jobs:
  build:
    name: Build
    uses: ./.github/workflows/build-binaries.yml
    with:
      tag_name: ${{ inputs.tag_name || github.event.release.tag_name }}
      is_release: true

  publish:
    name: Publish
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - name: linux
            path: ${{ needs.build.outputs.linux_x86_64 }}
            asset_name: function-runner-x86_64-linux-${{ inputs.tag_name || github.event.release.tag_name }}
            shasum_cmd: sha256sum
          - name: linux-arm64
            path: ${{ needs.build.outputs.linux_arm64 }}
            asset_name: function-runner-arm-linux-${{ inputs.tag_name || github.event.release.tag_name }}
            shasum_cmd: sha256sum
          - name: macos
            path: ${{ needs.build.outputs.macos_x86_64 }}
            asset_name: function-runner-x86_64-macos-${{ inputs.tag_name || github.event.release.tag_name }}
            shasum_cmd: shasum -a 256
          - name: arm64-macos
            path: ${{ needs.build.outputs.macos_arm64 }}
            asset_name: function-runner-arm-macos-${{ inputs.tag_name || github.event.release.tag_name }}
            shasum_cmd: shasum -a 256
          - name: windows
            path: ${{ needs.build.outputs.windows_x86_64 }}
            asset_name: function-runner-x86_64-windows-${{ inputs.tag_name || github.event.release.tag_name }}
            shasum_cmd: sha256sum

    steps:
      - name: Archive assets
        run: gzip -k -f ${{ matrix.path }} && mv ${{ matrix.path }}.gz ${{ matrix.asset_name }}.gz

      - name: Upload assets to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}.gz
          path: ${{ matrix.asset_name }}.gz

      - name: Upload assets to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ inputs.tag_name || github.event.release.tag_name }} ${{ matrix.asset_name }}.gz

      - name: Generate asset hash
        run: ${{ matrix.shasum_cmd }} ${{ matrix.asset_name }}.gz | awk '{ print $1 }' > ${{ matrix.asset_name }}.gz.sha256

      - name: Upload asset hash to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}.gz.sha256
          path: ${{ matrix.asset_name }}.gz.sha256

      - name: Upload asset hash to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ inputs.tag_name || github.event.release.tag_name }} ${{ matrix.asset_name }}.gz.sha256
