name: Publish

on:
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag name"
        required: true
        type: string

jobs:
  build:
    name: Build
    uses: ./.github/workflows/build-binaries.yml

  publish:
    name: Publish
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - name: x86_64-unknown-linux-gnu
            os: ubuntu-22.04 # Use oldest supported non-deprecated version so we link against older glibc version which allows running binary on a wider set of Linux systems
            path: target/x86_64-unknown-linux-gnu/release/function-runner
            shasum_cmd: sha256sum
            output_var: linux_x86_64
          - name: aarch64-unknown-linux-gnu
            os: ubuntu-22.04 # Use oldest supported non-deprecated version so we link against older glibc version which allows running binary on a wider set of Linux systems
            path: target/aarch64-unknown-linux-gnu/release/function-runner
            shasum_cmd: sha256sum
            output_var: linux_arm64
          - name: x86_64-apple-darwin
            os: macos-latest
            path: target/x86_64-apple-darwin/release/function-runner
            shasum_cmd: shasum -a 256
            output_var: macos_x86_64
          - name: aarch64-apple-darwin
            os: macos-latest
            path: target/aarch64-apple-darwin/release/function-runner
            shasum_cmd: shasum -a 256
            output_var: macos_arm64
          - name: x86_64-pc-windows-msvc
            os: windows-latest
            path: target\x86_64-pc-windows-msvc\release\function-runner.exe
            shasum_cmd: sha256sum
            output_var: windows_x86_64

    steps:
      - name: Archive assets
        run: gzip -k -f ${{ matrix.path }} && mv ${{ matrix.path }}.gz ${{ matrix.asset_name }}.gz

      # - name: Upload assets to artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: ${{ matrix.asset_name }}.gz
      #     path: ${{ matrix.asset_name }}.gz

      # - name: Upload assets to release
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: gh release upload ${{ inputs.tag_name || github.event.release.tag_name }} ${{ matrix.asset_name }}.gz

      # - name: Generate asset hash
      #   run: ${{ matrix.shasum_cmd }} ${{ matrix.asset_name }}.gz | awk '{ print $1 }' > ${{ matrix.asset_name }}.gz.sha256

      # - name: Upload asset hash to artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: ${{ matrix.asset_name }}.gz.sha256
      #     path: ${{ matrix.asset_name }}.gz.sha256

      # - name: Upload asset hash to release
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: gh release upload ${{ inputs.tag_name || github.event.release.tag_name }} ${{ matrix.asset_name }}.gz.sha256
